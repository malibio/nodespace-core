# Claude Code Development Container
FROM ubuntu:22.04

# Avoid prompts from apt
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    pkg-config \
    libssl-dev \
    python3 \
    python3-pip \
    wget \
    unzip \
    ca-certificates \
    tmux \
    gnupg \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# Install Google Chrome for chrome-devtools MCP
RUN wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - \
    && echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list \
    && apt-get update \
    && apt-get install -y google-chrome-stable \
    && rm -rf /var/lib/apt/lists/*

# Install additional shell utilities for better terminal experience
RUN apt-get update && apt-get install -y \
    zsh \
    vim \
    nano \
    htop \
    ripgrep \
    fd-find \
    bat \
    && rm -rf /var/lib/apt/lists/*

# Install latest Node.js (required for Claude Code)
RUN curl -fsSL https://deb.nodesource.com/setup_current.x | bash - \
    && apt-get install -y nodejs

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Install Bun
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

# Install Oh My Zsh for better shell experience
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended \
    && git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions \
    && git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting

# Configure zsh with useful plugins
RUN sed -i 's/plugins=(git)/plugins=(git rust bun docker zsh-autosuggestions zsh-syntax-highlighting)/' /root/.zshrc \
    && echo 'export PATH="/root/.bun/bin:/root/.cargo/bin:$PATH"' >> /root/.zshrc \
    && echo 'export CHROME_BIN=/usr/bin/google-chrome-stable' >> /root/.zshrc

# Install Claude Code using the official installer
RUN curl -fsSL https://claude.ai/install.sh | bash || \
    (echo "Claude Code installer failed, creating placeholder..." && \
     echo '#!/bin/bash\necho "âŒ Claude Code not installed. Please install manually inside container:"\necho "curl -fsSL https://claude.ai/install.sh | bash"\nexit 1' > /usr/local/bin/claude && \
     chmod +x /usr/local/bin/claude)

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update \
    && apt-get install -y gh \
    && rm -rf /var/lib/apt/lists/*

# Create workspace directory
WORKDIR /workspace

# Set up git
RUN git config --global init.defaultBranch main
RUN git config --global user.name "Container Dev"
RUN git config --global user.email "container@nodespace.dev"

# Repository will be cloned at runtime
WORKDIR /workspace

# Install common Rust tools
RUN cargo install cargo-watch

# Configure Chrome to run in headless mode for MCP
ENV CHROME_BIN=/usr/bin/google-chrome-stable
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable

# Create an entrypoint script
RUN echo '#!/bin/bash\n\
# Configure git to use token for GitHub if GITHUB_TOKEN is set\n\
if [ -n "$GITHUB_TOKEN" ]; then\n\
  git config --global credential.helper "!f() { echo username=token; echo password=$GITHUB_TOKEN; }; f"\n\
  git config --global url.\"https://github.com/\".insteadOf \"git@github.com:\"\n\
fi\n\
\n\
# Clone repository if it doesn'\''t exist\n\
if [ ! -d "/workspace/nodespace-core" ]; then\n\
  echo "ðŸ“¥ Cloning nodespace-core repository..."\n\
  if [ -n "$GITHUB_TOKEN" ]; then\n\
    git clone https://github.com/malibio/nodespace-core.git /workspace/nodespace-core\n\
  else\n\
    echo "âš ï¸ No GITHUB_TOKEN found. Trying GitHub CLI authentication..."\n\
    if command -v gh >/dev/null 2>&1 && gh auth status >/dev/null 2>&1; then\n\
      gh repo clone malibio/nodespace-core /workspace/nodespace-core\n\
    else\n\
      echo "âŒ No GitHub authentication available. Please provide GITHUB_TOKEN or authenticate GitHub CLI."\n\
    fi\n\
  fi\n\
  if [ $? -ne 0 ] || [ ! -d "/workspace/nodespace-core" ]; then\n\
    echo "âŒ Failed to clone repository. Creating empty workspace..."\n\
    mkdir -p /workspace/nodespace-core\n\
    cd /workspace/nodespace-core\n\
    git init\n\
    echo "# NodeSpace Development Container" > README.md\n\
    echo "Repository clone failed. You can manually clone or initialize your repo here." >> README.md\n\
  fi\n\
fi\n\
\n\
cd /workspace/nodespace-core\n\
\n\
# Set up terminal environment with proper sizing\n\
export TERM=xterm-256color\n\
\n\
# Apply terminal dimensions from environment variables\n\
if [ -n "$COLUMNS" ] && [ -n "$LINES" ]; then\n\
  echo "ðŸ“ Setting terminal size: ${COLUMNS}x${LINES}"\n\
  stty cols "$COLUMNS" rows "$LINES" 2>/dev/null || true\n\
  export COLUMNS\n\
  export LINES\n\
else\n\
  # Fallback to reasonable defaults\n\
  echo "âš ï¸  Terminal dimensions not provided, using defaults (120x40)"\n\
  export COLUMNS=120\n\
  export LINES=40\n\
  stty cols 120 rows 40 2>/dev/null || true\n\
fi\n\
\n\
# Configure bashrc with tmux auto-start and terminal size fixes\n\
cat >> /root/.bashrc << "BASHRC_EOF"\n\
# Terminal size management\n\
function fix_terminal_size() {\n\
    if [ -n "$COLUMNS" ] && [ -n "$LINES" ]; then\n\
        stty cols "$COLUMNS" rows "$LINES" 2>/dev/null || true\n\
    fi\n\
}\n\
\n\
# Fix terminal size on bash startup\n\
fix_terminal_size\n\
\n\
# Create resize function for manual terminal fixing\n\
function resize_terminal() {\n\
    local cols=${1:-120}\n\
    local rows=${2:-40}\n\
    echo "Resizing terminal to ${cols}x${rows}"\n\
    stty cols "$cols" rows "$rows"\n\
    export COLUMNS="$cols"\n\
    export LINES="$rows"\n\
    # Refresh tmux if we\'re in one\n\
    if [ -n "$TMUX" ]; then\n\
        tmux refresh-client\n\
    fi\n\
}\n\
\n\
# tmux available but not auto-started (Claude Code works better in plain bash)\n\
# To start tmux manually: tmux new-session -A -s development\n\
BASHRC_EOF\n\
\n\
# Create tmux config for better terminal handling\n\
cat > /root/.tmux.conf << "TMUX_EOF"\n\
# Terminal and display settings\n\
set -g default-terminal "xterm-256color"\n\
set-window-option -g automatic-rename on\n\
set-option -g set-titles on\n\
\n\
# Enable mouse support\n\
set -g mouse on\n\
\n\
# Terminal size handling\n\
set -g aggressive-resize on\n\
set-hook -g client-attached "refresh-client -S"\n\
set-hook -g client-resized "refresh-client -S"\n\
\n\
# Start window numbering at 1\n\
set -g base-index 1\n\
set -g pane-base-index 1\n\
\n\
# Key bindings for manual resize (Prefix + R)\n\
bind R command-prompt -p "Cols,Rows:" "run-shell \"stty cols %1 rows %2\""\n\
TMUX_EOF\n\
\n\
echo "ðŸš€ Claude Code Development Container Ready!"\n\
echo "Repository: /workspace/nodespace-core"\n\
echo "Available tools: git, rust, bun, claude (~/.local/bin/claude), gh, tmux, zsh"\n\
echo "Terminal size: ${COLUMNS:-120}x${LINES:-40}"\n\
echo "Terminal: zsh with Oh My Zsh (tmux available manually)"\n\
echo ""\n\
# Verify Chrome installation\n\
if command -v google-chrome-stable >/dev/null 2>&1; then\n\
  chrome_version=$(google-chrome-stable --version 2>/dev/null || echo "unknown")\n\
  echo "âœ… Chrome: $chrome_version (for chrome-devtools MCP)"\n\
else\n\
  echo "âš ï¸  Chrome: Not found - chrome-devtools MCP may not work"\n\
fi\n\
echo ""\n\
echo "Quick start:"\n\
echo "  git checkout -b feature/container-$(date +%s)"\n\
echo "  ~/.local/bin/claude"\n\
echo ""\n\
echo "If terminal sizing is wrong, use: resize_terminal [cols] [rows]"\n\
echo "To start tmux manually: tmux new-session -A -s development"\n\
echo "Multiple containers can run simultaneously with unique branches!"\n\
echo ""\n\
exec "$@"' > /entrypoint.sh && chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/zsh"]